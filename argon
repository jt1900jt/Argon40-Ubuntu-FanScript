#!/bin/bash

# Define constants
GITHUB_REPO="https://raw.githubusercontent.com/jt1900jt/Argon40-Ubuntu-FanScript/main"
SCRIPT_FILE="/usr/local/bin/argon_fan_control.py"
CONFIG_FILE="/etc/argon_fan_config.json"
SERVICE_FILE="/etc/systemd/system/argon_fan_control.service"

# Function to update the script from GitHub
update_fan_control() {
    echo "Updating the fan control script and configuration from GitHub..."

    # Download the latest fan control script
    sudo wget -O $SCRIPT_FILE "$GITHUB_REPO/argon_fan_control.py"
    sudo chmod +x $SCRIPT_FILE

    # Download the latest configuration file
    sudo wget -O $CONFIG_FILE "$GITHUB_REPO/fan_config.json"
    sudo chmod 644 $CONFIG_FILE

    # Reload the systemd service to apply the updates
    echo "Reloading the systemd service..."
    sudo systemctl daemon-reload && sudo systemctl restart argon_fan_control.service

    echo "Update complete."
}

# Function to get the current CPU temperature
get_cpu_temp() {
    temp=$(vcgencmd measure_temp | sed 's/[^0-9.]//g')
    if [ -n "$temp" ]; then
        echo "$temp"
    else
        echo "Failed to retrieve CPU temperature."
        exit 1
    fi
}

# Function to return the current fan speed based on the temperature
get_fan_speed() {
    # Get the current CPU temperature
    current_temp=$(get_cpu_temp)

    # Read the fan speed configuration from the config file
    fan_speeds=$(jq -r '.fan_speeds' $CONFIG_FILE)

    current_speed=0
    for temp in $(echo $fan_speeds | jq -r 'keys[]'); do
        if (( $(echo "$current_temp >= $temp" | awk '{print ($1 >= $2)}') )); then
            current_speed=$(echo $fan_speeds | jq -r --arg temp "$temp" '.[$temp]')
        fi
    done

    if [ -n "$current_speed" ]; then
        echo "Current fan speed: $current_speed%"
    else
        echo "Failed to determine the fan speed."
    fi
}

# Parse command line arguments
if [ "$1" == "-update" ]; then
    update_fan_control
elif [ "$1" == "-speed" ]; then
    get_fan_speed
else
    echo "Usage: argon -update, argon -speed"
    exit 1
fi
